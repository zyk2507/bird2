name: release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag to release (e.g. v2.18). If empty, a tag is generated.'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}
          fetch-depth: 0

      - name: Compute release tag
        id: release_tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          elif [ "${{ github.ref }}" != "" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            TAG="${{ github.ref_name }}"
          else
            VERSION="$(tr -d '[:space:]' < VERSION)"
            TAG="v${VERSION}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Ensure release tag exists
        if: github.event_name == 'workflow_dispatch'
        run: |
          git fetch --tags
          TAG="${{ steps.release_tag.outputs.tag }}"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag $TAG already exists"
          else
            git tag "$TAG"
            git push origin "$TAG"
          fi

      - name: Checkout release tag
        run: |
          git checkout "${{ steps.release_tag.outputs.tag }}"

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            autoconf automake libtool make gcc g++ bison flex \
            libreadline-dev libncurses-dev pkg-config \
            dpkg-dev rpm zip

      - name: Build packages
        run: bash packaging/scripts/build-release.sh

      - name: Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: |
            dist/*.deb
            dist/*.rpm
            dist/*.zip
